VIN decoder microservice
===============
Vehicle Identification Number(VIN) decoder server that consumes VIN number and produces vehicle detail in JSON. Read more about it here:  [Wikipedia](https://en.wikipedia.org/wiki/Vehicle_identification_number)

Requirements
------------
Tested with all combinations of:
* Python: 3.6
* Django: 2.0.1.
* Django REST framework: 3.7.7
* PostgreSQL: 10.1
* Gunicorn: 19.7.1

Gunicorn is optional but recommended if you planning to run in production.

Setup
-------
It's a good practice to use a virtual environment (or virtualenv) which is a feature built into Python that allows you to keep a separate directory of installed packages for each of your projects so that they donâ€™t interfere with each other.
***NOTE: This introductory guide is supposed to have you Ubuntu/Debian system and latest Python 3rd version along with pip installed***
```sh
$ mkdir ~/.virtualenvs
$ pip install virtualenv
$ virtualenv --python=`python` ~/.virtualenvs/vin-decoder
$ source ~/.virtualenvs/vin-decoder/bin/activate
```
Anything you install through **pip** will be installed in your new virtualenv, isolated from other environments and system-wide packages.

Install all project dependencies from **pip**:
```sh
$ pip install -r requirements.txt
```
**requirements.txt** file located in the root of the project directory.

Synchronize Django models with the database:
```sh
$ python manage.py migrate
```
Run the server:
```sh
$ python manage.py runserver
```
The server will be listening on 8000 port by default, go to the browser and open http://localhost:8000/api/v1/decode/<VIN>

The server should return JSON result, e.g:
```json
{
    VIN: "1GYKNDRS6JZ111410",
    year: 2018,
    make: "Cadillac",
    model: "XT5",
    type: "SPORT UTILITY 4-DR",
    color: "",
    dimensions: {
        Wheelbase: "112.50",
        Rear Legroom: "39.50",
        Front Legroom: "41.20",
        Overall Width: "75.00",
        Rear Headroom: "36.00",
        Rear Hip Room: "54.70",
        Front Headroom: "38.40",
        Front Hip Room: "56.00",
        Overall Height: "66.00",
        Overall Length: "189.50",
        Rear Shoulder Room: "56.20",
        Front Shoulder Room: "58.30"
    },
    weight: { },
    status: {
        code: "SUCCESS",
        message: ""
    }
}
```
Vehicle details are generated by retrieving data from the database or third-party API service. 

Configuration
-------------
There are not much you have to do any configuration in the Django **settings.py** file. However, It's good to take a look to some options:
```
if os.getenv('DJANGO_ENV') == 'prod':
    DEBUG = False
else:
    DEBUG = True
ALLOWED_HOSTS = ['localhost']
```
DJANGO_ENV is set while running Docker container.
```
if os.getenv('DOCKER_CONTAINER'):
    POSTGRES_HOST = 'vin-postgres'
else:
    POSTGRES_HOST = '127.0.0.1'

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql_psycopg2',
        'NAME': 'vindata',
        'USER': 'vinuser',
        'PASSWORD': 'vinpass',
        'HOST': POSTGRES_HOST,
        'PORT': '',
    }
}
```
DOCKER_CONTAINER is set to the Docker environment while running the container.
It helps us by being able to query whether our Django application is running in a container and setting the database host accordingly.

There is a third-party API service to decode VIN [DecodeThis](https://www.decodethis.com/blog/api_documentation), the service URL can be found in the **vinapi/configs.py** in format 
```
https://www.decodethis.com/webservices/decodes/{vin}/{key}/1.json'
```
The service requires API_KEY to to be able to retrieve VIN information from DecodeThis. Set up a new account in the service to get a trial KEY.

Admin
-----
Django supports built-in admin interface to handle models data with basic CRUD operations.  
To have an admin panel access you have to create a superuser first using either django-admin tool or passing commands to the manage.py :
```sh
$ python manage.py createsuperuser
```
You will then be prompted to enter Username/Password and admin email address.

After creating the credentials you can access the admin interface:
http://localhost:8000/admin/vinapi/

**Note: If you are running vin-decoder from the Docker image, there will be created a default admin/rhjrjlbk84637857 admin credentials**

Admin credentials are set inside **start.sh** file 
```sh
echo "from django.contrib.auth.models import User; User.objects.filter(email='admin@example.com').delete(); User.objects.create_superuser('admin', 'admin@example.com', 'sardor')" | python manage.py shell
```

Tests
-----
To run tests simply run the command:
```
python manage.py test -v 2
```
Turn on a verbose mode to have a full test observation.

Docker run
----------
Make sure you have Docker installed:
```sh
$ docker run hello-world

Hello from Docker.
This message shows that your installation appears to be working correctly.
...
```
Install docker-compose package to run multiple containers in one.
```sh
pip install docker-compose
```
Make sure you are running a docker-compose from the root of the project folder, since the docker-compose will look for its YAML configuration file which is located in the project base directory **/docker-compose.yml**
```sh
$ docker-compose up  
```
It you look into the YAML file you will notice that first we deploy a postgresql database image tagged as *vin-postgres* that is oficially dockerized in the Docker Hub.
Then it runs *vin-decoder* image which is already published in the Hub
After we run NGINX modified docker to serve static files, fixed issue [#e0722cd](https://bitbucket.org/snavruzov/vin_decoder/commits/e0722cdf7945c9992d17f0d50c89806c2de13563)

It's strongly recommended when in production mode never, ever put gunicorn in front. Instead use a server like nginx which dispatches requests to a pool of gunicorn workers and also serves the static files. 

REST documentation
-------------
Vin-decoder REST endpoints have a detailed description adapted for [Swagger](https://swagger.io) documentation tool. Documentation YAML file can be found in the base folder **swagger.yaml**.

Troubleshooting
---------------
```
ERROR:  relation "vinapi_basic" does not exist at character 205
```
Make sure you have run **python manage.py migrate** to propagate Django models into the PostgreSQL datatabase.
```
django.db.utils.OperationalError: could not connect to server: Connection refused
```
Check your database connection, make sure it's running on **5432**, if you're deploying vin-decoder from the Docker Hub you should first run PostgreSQL docker image and link it to the vin-decoder image.
```sh
$ docker run --name vin-postgres -p 5432:5432 -e POSTGRES_USER=vinuser -e POSTGRES_PASSWORD=vinpass -e POSTGRES_DB=vindata -d postgres:lates
$ docker run -it --link vin-postgres:postgres -p 8000:8000 snavruzov/vin-decoder
```
Notice how we linked database tag using link flag *--link vin-postgres:postgres*.
